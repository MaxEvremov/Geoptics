<style>
	.just-padding {
		padding: 15px;
	}

	.list-group.list-group-root {
		padding: 0;
		overflow: hidden;
	}

	.list-group.list-group-root .list-group {
		margin-bottom: 0;
	}

	.list-group.list-group-root .list-group-item {
		border-radius: 0;
		border-width: 1px 0 0 0;
	}

	.list-group.list-group-root > .list-group-item:first-child {
		border-top-width: 0;
	}

	.list-group.list-group-root > .list-group > .list-group-item {
		padding-left: 30px;
	}

	.list-group.list-group-root > .list-group > .list-group > .list-group-item {
		padding-left: 45px;
	}

	.list-group-item .glyphicon {
		margin-right: 5px;
	}

	.dygraph-legend {
		padding: 10px;
		border-radius: 3px;
		margin: 5px;
		box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.20);
		background: rgba(255, 255, 255, 0.8)!important;
		z-index: 100!important;
	}

	.dygraph-legend > * {
		display: block;
	}

	.dygraphDefaultAnnotation {
		line-height: 14px;
		border: 0;
		box-shadow: 1px 1px 1px 0px rgba(0, 0, 0, 0.37);
		color: white !important;
	}

	.placeholder {
		font-size: 0.8em;
		color: #999;
		padding: 1em;
		font-size: 1em;
		text-align: center;
		width: 100%;
		background: #B0B6B9;
		color: #fff;
	}

	#dygraph_box_body .placeholder {
		position: absolute;
		top: 50px;
	}

	#dygraph_container .line {
		visibility: hidden;
		background-color: black;
		position: absolute;
		pointer-events: none;
		width: 1px;
		height: 100%;
		top: 0;
		margin-top: -20px;
	}

	.box-toolbar {
		position: absolute;
		top: 0;
		right: 0;
		padding: 5px;
	}

	.dygraph-box {
		position: relative;
		padding: 0
	}

	.dygraph-axis-label {
		text-align: center!important
	}

	.axis-input-block {
		position: absolute;
		z-index: 10
	}

	.axis-input-block input {
		position: absolute;
		display: none;
		border-radius: 3px;
		border: 1px inset #eee;
		padding: 0px 3px;
	}

	.axis-input-block:hover input,
	.axis-input-block input:focus {
		display: block;
	}

	.axis-input-block-left {
		left: -20px;
		top: 0;
		bottom: 0;
		width: 50px;
	}

	.axis-input-block-left-top {
		right: 0px;
		top: 0;
		width: 40px;
	}

	.axis-input-block-left-bottom {
		right: 0px;
		bottom: 0;
		width: 40px;
	}

	.axis-input-block-bottom {
		left: 31px;
		right: 5px;
		bottom: -5px;
		height: 20px;
	}

	.axis-input-block-bottom-left {
		left: 0;
		bottom: 0;
		width: 10em;
	}

	.axis-input-block-bottom-right {
		right: 0;
		bottom: 0;
		width: 10em;
	}

	.box-toolbar .adjustRoll input {
		width: 2em;
		border-radius: 3px;
		border: 1px inset #eee;
		padding: 0px 3px;
	}

	.dygraph-annotation-deviation {
		background-color: red;
		color: white;
	}

	.dygraph-annotation-event,
	.dygraph-annotation-length {
		background-color: #666;
	}

	.plotpoints tr {
		cursor: pointer;
	}

	#avg_click_box {
		position: fixed;
		display: block;
		width: 250px;
		z-index: 13;
		border: 2px solid rgba(0, 0, 0, 0.2);
	}

	.timeline-events {
		font-size: 0.9em;
	}

	.timeline-events > li {
		padding: 0.7em 0;
		border-bottom: 1px solid #eee;
	}

	.timeline-events > li:last-child {
		border-bottom: 0;
	}

	#dygraph_avg_container {
		margin-left: -13px;
	}

	.dygraph-loading-overlay {
		width: 100%;
		height: 100%;
		position: absolute;
		text-align: center;
		z-index: 12;
		font-size: 24px;
		line-height: 150px;
	}

	.loading {
		-webkit-filter: blur(2px);
		pointer-events: none;
	}

	#dygraph_container > div > canvas {
		-webkit-filter: blur(0.0000001px);
	}

    .length-annotation-select {
        height: 34px;
    }

    .length-annotation-select > select {
        width: 85%;
        float: left;
    }

    .length-annotation-select > div {
        width: 10%;
        height: 34px;
        float: right;
    }
</style>

<ul id="avg_click_box" data-bind="
    visible: is_point_box_visible,
    style: {
        top: point_box_top,
        left: point_box_left
    }
" class="dropdown-menu" role="menu">
	<li style="padding:10px 20px">
		<p data-bind="html: helpers.formatDate(selected_date())"></p>
	</li>
	<li><a href="#" data-bind="click: getNearestTempPlot">Получить ближайший график</a></li>
	<li data-bind="click: getAvgTempPlot.bind($data, 1, 'h')">
		<a href="#">Усреднить за час</a>
	</li>
	<li data-bind="click: getAvgTempPlot.bind($data, 1, 'd')">
		<a href="#">Усреднить за день</a>
	</li>
	<li data-bind="click: getAvgTempPlot.bind($data, 3, 'd')">
		<a href="#">Усреднить за три дня</a>
	</li>
</ul>

<section class="content" data-bind="event: { mouseup: hidePointBox }">
	<div class="row">
		<div class="col-md-9">
			<div class="box box-info box-borderless" style="position:relative;min-height:20%">
				<div class="box-header">
					<h3 class="box-title">Давление
                        <a class="btn btn-xs" title="В Избранное" data-bind="
                            click: saveFavorite,
                            css: {
                                flash: is_favorite_saved,
                                animated: is_favorite_saved
                            }
                        ">
                            <i class="fa fa-star"></i>
                        </a>
                </h3>
				</div>

				<div class="box-body dygraph-box">
                    <div class="dygraph-loading-overlay" data-bind="visible: is_loading_pressure_data() || !has_data()">
                        <!-- ko if: is_loading_pressure_data -->
                        <i class="fa fa-spin fa-spinner"></i>
                        <!-- /ko -->

                        <!-- ko ifnot: has_data -->
                        У этой скважины еще нет данных
                        <!-- /ko -->
                    </div>

					<div id="dygraph_avg_container" class="plot" data-bind="css: { loading: is_loading_pressure_data }, visibility: has_data"></div>

					<div class="axis-input-block axis-input-block-left">
						<input class="axis-input-block-left-top" data-bind="
                            value: max_zoom_y,
                            event: { keypress: updateZoomY }">
						<input class="axis-input-block-left-bottom" data-bind="
                            value: min_zoom_y,
                            event: { keypress: updateZoomY }">
					</div>

					<div class="axis-input-block axis-input-block-bottom">
						<input class="axis-input-block-bottom-left" data-bind="
                        value: min_zoom_x,
                        event: { keypress: updateZoomX },
                        jmask: {
                            value: min_zoom_x,
                            mask: '00/00/00 00:00',
                            options: {
                                placeholder: '__/__/__ __:__'
                            }
                        }
                        ">
						<input class="axis-input-block-bottom-right" data-bind="
                        value: max_zoom_x,
                        event: { keypress: updateZoomX },
                        jmask: {
                            value: max_zoom_x,
                            mask: '00/00/00 00:00',
                            options: {
                                placeholder: '__/__/__ __:__'
                            }
                        }
                        ">
					</div>
				</div>

				<div class="box-toolbar">
					<a class="" title="Сбросить увеличение" data-bind="click: resetPlotAvgState">
						<i class="fa fa-repeat"></i>
					</a>

					<a class="adjustRoll" title="Сглаживание">
						<input class="" placeholder="" type=number data-bind="value: adjustRoll"></input>
					</a>
				</div>
			</div>

			<div id="dygraph_box" class="box box-danger box-borderless" style="position:relative;min-height:80%;margin-bottom: 0px;">
				<div id="dygraph_box_body" class="box-body" style="height: 100%;">
					<div class="dygraph-loading-overlay" data-bind="visible: is_loading_temp_data">
						<i class="fa fa-spin fa-spinner"></i>
					</div>

					<div class="graph-annotation-overlay" data-bind="
					visible: is_main_plot_visible(),
					foreach: length_annotations.annotations" >
						<div class="graph-annotation-overlay__zone" data-bind="
                            css: css_class,
    						style: style">
                        </div>
					</div>

					<div id="dygraph_container" class="plot" data-bind="
                        style: {
                            visibility: is_main_plot_visible() && has_data()
                            ? 'visible' : 'hidden'
                        },
                        css: { loading: is_loading_temp_data }">
					</div>

					<p class="placeholder noselect" data-bind="
                        style: {
                            visibility: is_main_plot_visible() || !has_data()
                            ? 'hidden' : 'visible'
                        },
                        css: { loading: is_loading_temp_data }
                    ">
						<!-- ko if: current_mode() === 'reference_point' -->
						Выберите точку на графике давления
						<!-- /ko -->

						<!-- ko ifnot: current_mode() === 'reference_point' -->
						Выберите хотя бы одну точку на графике давления
						<!-- /ko -->
					</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="box box-info box-borderless" data-bind="visible: current_mode() === 'normal' && has_data()">
				<div class="box-header">
					<h3 class="box-title">Точки</h3>
				</div>

				<div class="box-body">
					<!-- ko ifnot: selected_plots().length === 0 -->
					<table class="table plotpoints" style="font-size: 0.8em;">
						<tbody data-bind="foreach: selected_plots">
							<tr>
								<td data-bind="
                                text: $index() + 1,
                                style: {
                                    backgroundColor: color
                                }
                                " style="color: #fff;"></td>
								<td data-bind="click: $parent.showPoint">
									<span data-bind="html: description"></span>
								</td>
								<td class="btn-hoverable" data-bind="click: $parent.removePoint" style="width: 30px;">
									<a title='Удалить'><i class="fa fa-times"></i></a>
								</td>
								<td class="btn-hoverable" data-bind="click: downloadLAS" style="width: 30px;">
									<a title='Скачать как LAS'><i class="fa fa-download"></i></a>
								</td>
							</tr>
						</tbody>
					</table>
					<!-- /ko -->

					<!-- ko if: selected_plots().length === 0 -->
					<p class="placeholder noselect">Выберите хотя бы одну точку на графике давления</p>
					<!-- /ko -->
				</div>
			</div>

			<div class="box box-danger box-borderless" data-bind="visible: current_mode() === 'reference_point', with: reference_point">
				<div class="box-header">
					<h3 class="box-title">Эталонная точка</h3>
				</div>

				<div class="box-body" data-bind="with: point">
					<ul class="list-unstyled">
						<li>Глубина: <span data-bind="text: length"></span></li>
						<li>Температура: <span data-bind="text: temp"></span></li>
					</ul>
				</div>

				<div class="box-footer">
					<a class="btn btn-sm btn-danger" data-bind="click: save, css: { 'btn-disabled': !is_save_allowed() }">
						<span>Сохранить</span>
					</a>
                    <!-- ko if: point().temp() && point().length() -->
                    <a class="btn btn-sm btn-danger" data-bind="click: deletePoint">
						<span>Удалить</span>
					</a>
                    <!-- /ko -->
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
				</div>
			</div>

			<div class="box box-danger box-borderless" data-bind="visible: current_mode() === 'min_length', with: min_length">
				<div class="box-header">
					<h3 class="box-title">Выбор нуля глубины</h3>
				</div>

				<div class="box-body">
					<ul class="list-unstyled">
						<li>Ноль глубины: <span data-bind="text: value"></span></li>
					</ul>
				</div>

				<div class="box-footer">
					<a class="btn btn-sm btn-danger" data-bind="click: save, css: { 'btn-disabled': !is_save_allowed() }">
						<span>Сохранить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
				</div>
			</div>

			<div class="box box-danger box-solid" data-bind="visible: current_mode() === 'timeline_event', with: timeline_events">
				<div class="box-header">
					<h3 class="box-title">События на таймлайне</h3>
				</div>

				<div class="box-body">
					<!-- ko if: events().length === 0 -->
					<p class="placeholder">У вас пока нет событий</p>
					<!-- /ko -->

					<!-- ko ifnot: events().length === 0 -->
					<ul class="list-unstyled timeline-events" data-bind="foreach: events">
						<li>
							<!-- ko ifnot: $parent.is_editing() && $parent.current_event().id == $data.id -->
							<b data-bind="
                                text: short_text
                            "></b>
							<span class="btn-hoverable pull-right">
								<a data-bind="click: $parent.editEvent">
									<i class="fa fa-pencil"></i>
								</a>
								<a data-bind="click: $parent.removeEvent">
									<i class="fa fa-times"></i>
								</a>
							</span>
							<div style="overflow-wrap: break-word;">
								<span data-bind="text: description"></span>
								<span class="formatDate" data-bind="text: jmask_date"></span>
							</div>

							<!-- /ko -->

							<!-- ko if: $parent.is_editing() && $parent.current_event().id == $data.id -->
							<!-- ko with: $parent.current_event -->
							<div class="editbox timeline-event-template" data-bind="template: { name: 'timeline-event-template' }">
							</div>
							<!-- /ko -->
							<!-- /ko -->
						</li>
					</ul>
					<!-- /ko -->

					<!-- ko ifnot: is_editing -->
					<a class="btn btn-sm btn-danger" data-bind="click: createEvent">
						<span>Добавить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
					<!-- /ko -->

					<!-- ko if: is_editing() && !current_event().id -->
                    <!-- ko with: current_event -->
					<div class="editbox timeline-event-template" data-bind="template: 'timeline-event-template'"></div>
					<!-- /ko -->
                    <!-- /ko -->
				</div>
			</div>

			<div class="box box-danger box-solid" data-bind="visible: current_mode() === 'length_annotation', with: length_annotations">
				<div class="box-header">
					<h3 class="box-title">Конструкционные элементы</h3>
				</div>

				<div class="box-body">
					<!-- ko if: annotations().length === 0 -->
					<p class="placeholder">У вас пока не отмечены конструкционные элементы</p>
					<!-- /ko -->

					<!-- ko ifnot: annotations().length === 0 -->
					<ul class="list-unstyled timeline-events" data-bind="foreach: annotations">
						<li>
							<!-- ko ifnot: $parent.is_editing() && $parent.current_annotation().id == $data.id -->
							<b data-bind="
                                text: name
                            "></b> (<i data-bind="text: texture_name"></i>)
							<span class="btn-hoverable pull-right"> <a data-bind="click: $parent.editAnnotation">
                                <i class="fa fa-pencil"></i>
                            </a>
                            <a  data-bind="click: $parent.removeAnnotation">
                                <i class="fa fa-times"></i>
                            </a></span>
							<div>
								<span data-bind="text: y1"></span>м - <span data-bind="text: y2"></span>м
							</div>

							<!-- /ko -->

							<!-- ko if: $parent.is_editing() && $parent.current_annotation().id == $data.id -->
							<div>
								<!-- ko with: $parent.current_annotation -->
								<div class="box box-default box-borderless timeline-event-template" data-bind="template: { name: 'length-annotation-template' }">
								</div>
								<!-- /ko -->
							</div>
							<!-- /ko -->
						</li>
					</ul>
					<!-- /ko -->

					<!-- ko ifnot: is_editing -->
					<a class="btn btn-sm btn-danger" data-bind="click: createAnnotation">
						<span>Добавить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
					<!-- /ko -->

					<!-- ko if: is_editing() && !current_annotation().id -->
                    <!-- ko with: current_annotation -->
					<div class="box box-default box-borderless timeline-event-template" data-bind="template: 'length-annotation-template'"></div>
                    <!-- /ko -->
					<!-- /ko -->
				</div>
			</div>
		</div>
	</div>
</section>

<script type="text/html" id="timeline-event-template">
	<div>
		<ul class="list-unstyled">
			<li class="form-group">
				<label>Дата:</label>
				<input class="form-control" class="axis-input-block-bottom-right" data-bind="
                textInput: jmask_date,
                jmask: {
                    mask: '00/00/00 00:00',
                    options: {
                        placeholder: '__/__/__ __:__'
                    }
                }
                ">
			</li>
			<li class="form-group">
				<label>Краткое обозначение:</label>
				<input class="form-control" data-bind="textInput: short_text">
			</li>
			<li class="form-group">
				<label>Описание:</label>
				<textarea class="form-control" data-bind="textInput: description" style="
                    width: 100%;
                    min-height: 5em;
                    resize: vertical;
                "></textarea>
			</li>
		</ul>
	</div>

	<div>
		<a class="btn btn-sm btn-danger" data-bind="click: m_site.plots.timeline_events.saveEvent">
			<span>Сохранить</span>
		</a>
		<a class="btn btn-sm btn-default" data-bind="click: m_site.plots.timeline_events.cancelEditingEvent">
			<span>Отмена</span>
		</a>
	</div>
</script>

<script type="text/html" id="length-annotation-template">
    <div>
		<ul class="list-unstyled">
			<li class="form-group">
				<label>Название:</label>
				<input class="form-control" data-bind="textInput: name">
			</li>
            <li class="form-group">
				<label>Текстура:</label>
                <div class="length-annotation-select">
                    <select class="form-control" data-bind="
                        options: LengthAnnotation.TEXTURES,
                        optionsCaption: 'Выберите текстуру...',
                        optionsText: 'name',
                        optionsValue: 'css_class',
                        value: css_class
                    "></select>
                    <!-- ko if: css_class -->
                    <div data-bind="
                        css: css_class">
                    </div>
                    <!-- /ko -->
                </div>
			</li>
            <li class="form-group">
				<label>Начало отметки (м):</label>
				<input class="form-control" data-bind="textInput: y1">
			</li>
            <li class="form-group">
				<label>Конец отметки (м):</label>
				<input class="form-control" data-bind="textInput: y2">
			</li>
		</ul>
	</div>

	<div>
		<a class="btn btn-sm btn-danger" data-bind="click: m_site.plots.length_annotations.saveAnnotation">
			<span>Сохранить</span>
		</a>
		<a class="btn btn-sm btn-default" data-bind="click: m_site.plots.length_annotations.cancelEditingAnnotation">
			<span>Отмена</span>
		</a>
	</div>
</script>
