<link href="../css/plots.css" rel="stylesheet">

<!-- ko with: point_box -->
<ul id="avg_click_box" data-bind="
    visible: is_visible() && mode() === 'normal',
    style: {
        top: top,
        left: left
    }
" class="dropdown-menu click-box" role="menu">
    <li style="padding: 10px 20px;">
        <span>Текущий датчик</span> <select class="form-control" data-bind="
            options: $parent.current_well().depth_sensors,
            optionsText: 'name',
            optionsValue: 'id',
            value: $parent.selected_depth_sensor
        ">
        </select>
    </li>

	<li style="padding: 10px 20px;">
		<p data-bind="html: helpers.formatDate(selected_date())"></p>
	</li>
    <!-- ko ifnot: $parent.current_mode() === 'color' -->
	<li><a href="#" data-bind="click: getNearestTempPlot">Получить ближайший график</a></li>
	<li data-bind="click: getAvgTempPlot.bind($data, 1, 'h')">
		<a href="#">Усреднить за час</a>
	</li>
	<li data-bind="click: getAvgTempPlot.bind($data, 1, 'd')">
		<a href="#">Усреднить за день</a>
	</li>
	<li data-bind="click: getAvgTempPlot.bind($data, 3, 'd')">
		<a href="#">Усреднить за три дня</a>
	</li>
    <li data-bind="click: getAvgTempPlotForVisibleRange">
		<a href="#">Усреднить по видимому диапазону</a>
	</li>
    <!-- /ko -->
    <li data-bind="click: openColorTempBox">
		<a href="#">Построить цветовой график</a>
	</li>
</ul>

<ul id="color_temp_box" data-bind="
    visible: is_visible() && mode() === 'color',
    style: {
        top: top,
        left: left
    }
" class="dropdown-menu click-box" role="menu">
    <li class="form-group">
        <input data-bind="textInput: color_temp_number" class="form-control" placeholder="Число графиков" />
    </li>
    <li class="form-group time-group">
        <input data-bind="textInput: color_temp_interval" class="form-control" placeholder="Интервал усреднения" />

        <select class="form-control" data-bind="
            options: Plot.TIME_UNITS,
            optionsText: 'name',
            optionsValue: 'unit',
            value: color_temp_interval_unit
        "></select>
    </li>
    <li class="form-group time-group">
        <input data-bind="textInput: color_temp_period" class="form-control" placeholder="Период усреднения" />

        <select class="form-control" data-bind="
            options: Plot.TIME_UNITS,
            optionsText: 'name',
            optionsValue: 'unit',
            value: color_temp_period_unit
        "></select>
    </li>

    <div>
        <a class="btn btn-sm btn-danger" data-bind="click: renderColorTemp">
            <span>Построить цветовой график</span>
        </a>
        <a class="btn btn-sm btn-default" data-bind="click: closeColorTempBox">
            <span>Отмена</span>
        </a>
    </div>
</ul>
<!-- /ko -->

<section class="content" data-bind="event: { mouseup: hideBoxes }" style="height: 100%; padding-bottom: 0;">
	<div class="row" style="height: 100%;">
		<div class="col-md-9">
			<div class="box box-info box-borderless" style="position:relative;min-height:20%;">
				<div class="box-header">
					<h3 class="box-title">Давление
                        <!-- ko if: current_mode() === 'normal' -->
                        <a class="btn btn-xs" title="В Избранное" data-bind="
                            click: saveFavorite,
                            css: {
                                flash: is_favorite_saved,
                                animated: is_favorite_saved
                            }
                        ">
                            <i class="fa fa-star"></i>
                        </a>
                        <!-- /ko -->
                </h3>
				</div>

				<div class="box-body dygraph-box">
                    <div class="dygraph-loading-overlay" data-bind="visible: is_loading_pressure_data() || !has_data()">
                        <!-- ko if: is_loading_pressure_data -->
                        <i class="fa fa-spin fa-spinner"></i>
                        <!-- /ko -->

                        <!-- ko ifnot: has_data -->
                        У этой скважины еще нет данных
                        <!-- /ko -->
                    </div>

					<div id="dygraph_avg_container" class="plot" data-bind="css: { loading: is_loading_pressure_data }, visibility: has_data"></div>

					<div class="axis-input-block axis-input-block-left">
						<input class="axis-input-block-left-top" data-bind="
                            textInput: max_zoom_y,
                            event: { keypress: updateZoomY }">
						<input class="axis-input-block-left-bottom" data-bind="
                            textInput: min_zoom_y,
                            event: { keypress: updateZoomY }">
					</div>

					<div class="axis-input-block axis-input-block-bottom">
						<input class="axis-input-block-bottom-left" data-bind="
                        textInput: min_zoom_x,
                        event: { keypress: updateZoomX },
                        jmask: {
                            value: min_zoom_x,
                            mask: '00/00/00 00:00',
                            options: {
                                placeholder: '__/__/__ __:__'
                            }
                        }
                        ">
						<input class="axis-input-block-bottom-right" data-bind="
                        textInput: max_zoom_x,
                        event: { keypress: updateZoomX },
                        jmask: {
                            value: max_zoom_x,
                            mask: '00/00/00 00:00',
                            options: {
                                placeholder: '__/__/__ __:__'
                            }
                        }
                        ">
					</div>
				</div>

				<div class="box-toolbar">
					<span class="adjustRoll" title="Сглаживание">
						Сглаживание <input type="number" data-bind="textInput: adjustRoll"></input>
					</span>
				</div>
			</div>

			<div id="dygraph_box" class="box box-danger box-borderless" style="position:relative;min-height:80%;margin-bottom: 0px;">
				<div id="dygraph_box_body" class="box-body" style="height: 100%;">
					<div class="dygraph-loading-overlay" data-bind="visible: is_loading_temp_data">
                        <!-- ko ifnot: processed() && total() -->
						<i class="fa fa-spin fa-spinner"></i>
                        <!-- /ko -->
                        <!-- ko if: processed() && total() -->
                        <div class="progress" style="width: 200px; display: inline-block;">
                            <div class="progress-bar progress-bar-primary progress-bar-striped" data-bind="style: { width: processed() / total() * 100 + '%' }">
                            </div>
                        </div>
                        <!-- /ko -->
					</div>

					<div class="graph-annotation-overlay" data-bind="
					visible: is_main_plot_visible(),
					foreach: length_annotations.annotations" >
						<div class="graph-annotation-overlay__zone" data-bind="
    						style: style,
                            attr: { title: name }">
                        </div>
					</div>

					<div id="dygraph_container" class="plot" data-bind="
                        style: {
                            visibility: is_main_plot_visible() && has_data()
                            ? 'visible' : 'hidden'
                        },
                        css: { loading: is_loading_temp_data }">
					</div>

					<p class="placeholder noselect" data-bind="
                        style: {
                            visibility: is_main_plot_visible() || !has_data()
                            ? 'hidden' : 'visible'
                        },
                        css: { loading: is_loading_temp_data }
                    ">
						<!-- ko if: current_mode() === 'reference_point' -->
						Выберите точку на графике давления
						<!-- /ko -->

						<!-- ko ifnot: current_mode() === 'reference_point' -->
						Выберите хотя бы одну точку на графике давления
						<!-- /ko -->
					</p>
				</div>
			</div>
		</div>

		<div class="col-md-3" style="height: 100%;">
			<div class="box box-info box-borderless" data-bind="visible: current_mode() === 'normal' && has_data()" style="height: 100%; margin-bottom: 0;">
				<div class="box-header" style="height: 6%;">
					<h3 class="box-title">Графики по глубине</h3>

                    <a data-bind="click: togglePlotsMenu" style="float: right;">
                        <i class="fa fa-bars"></i>
                    </a>

                    <ul id="plots_menu_box" data-bind="
                        visible: is_plots_menu_visible
                    " class="dropdown-menu click-box" role="menu">
                        <li>
                            <a data-bind="click: downloadAllAsLAS">
                                <i class="fa fa-download"></i> Выгрузить все графики в виде LAS
                            </a>
                        </li>
                        <li>
                            <a data-bind="click: removeAllPlots">
                                <i class="fa fa-times"></i> Удалить все выбранные графики
                            </a>
                        </li>
                    </ul>
				</div>

				<div class="box-body" style="height: 94%;">
                    <div style="height: 100%; overflow-x: hidden; overflow-y: auto; margin-bottom: 10px;">
                        <ul id="plot_menu_box" data-bind="
                            visible: is_plot_menu_visible,
                            style: {
                                top: plot_menu_top,
                                left: plot_menu_left
                            }
                        " class="dropdown-menu click-box" role="menu">
                            <!-- ko with: selected_plot -->
                            <li>
                                <a data-bind="click: $parent.removePoint">
                                    <i class="fa fa-times"></i> Удалить
                                </a>
                            </li>
                            <li>
                                <a data-bind="click: downloadLAS">
                                    <i class="fa fa-download"></i> Скачать LAS
                                </a>
                            </li>
                            <!-- /ko-->
                        </ul>

                        <!-- ko ifnot: selected_plots().length === 0 -->
                        <table class="table plotpoints" style="font-size: 0.8em; margin-bottom: 0;">
                            <tbody data-bind="foreach: selected_plots">
                                <tr>
                                    <td data-bind="
                                    text: $index() + 1,
                                    style: {
                                        backgroundColor: color
                                    }
                                    " style="color: #fff;"></td>
                                    <td data-bind="click: $parent.showPoint">
                                        <span data-bind="html: description"></span>
                                    </td>
                                    <td>
                                        <a data-bind="click: $parent.showPlotMenu" style="float: right;">
                                            <i class="fa fa-bars"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- /ko -->

                        <!-- ko if: selected_plots().length === 0 -->
    					<p class="placeholder noselect">Выберите хотя бы одну точку на графике давления</p>
    					<!-- /ko -->
                    </div>
				</div>
			</div>

            <div class="box box-info box-borderless" data-bind="visible: current_mode() === 'color'" style="height: 100%; margin-bottom: 0;">
                <div class="box-header" style="height: 6%;">
                    <h3 class="box-title">Цветовой график</h3>
                    <!-- ko ifnot: selected_plots().length === 0 -->
                    <a data-bind="click: cancelColorMode" title="Выйти из режима цветового графика" class="btn btn-hoverable" style="float: right;">
                        <i class="fa fa-times"></i>
                    </a>
                    <!-- /ko -->
                </div>

                <div class="box-body" style="height: 94%;">
                    <div style="height: 60%; overflow-x: hidden; overflow-y: auto; margin-bottom: 10px;">
                        <!-- ko ifnot: selected_plots().length === 0 -->
                        <table class="table plotpoints" style="font-size: 0.8em; margin-bottom: 0;">
                            <tbody data-bind="foreach: selected_plots">
                                <tr>
                                    <td data-bind="
                                    text: $index() + 1,
                                    style: {
                                        backgroundColor: color
                                    }
                                    " style="color: #fff;"></td>
                                    <td data-bind="click: $parent.showPoint">
                                        <span data-bind="html: description"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- /ko -->
                    </div>

                    <div id="renderer_div">
                    </div>
                </div>
            </div>

			<div class="box box-danger box-borderless" data-bind="visible: current_mode() === 'reference_point', with: reference_point">
				<div class="box-header">
					<h3 class="box-title">Эталонная точка</h3>
				</div>

				<div class="box-body" data-bind="with: point">
					<ul class="list-unstyled">
						<li>Глубина: <span data-bind="text: length"></span></li>
						<li>Температура: <span data-bind="text: temp"></span></li>
					</ul>
				</div>

				<div class="box-footer">
					<a class="btn btn-sm btn-danger" data-bind="click: save, css: { 'btn-disabled': !is_save_allowed() }">
						<span>Сохранить</span>
					</a>
                    <!-- ko if: point().temp() && point().length() -->
                    <a class="btn btn-sm btn-danger" data-bind="click: deletePoint">
						<span>Удалить</span>
					</a>
                    <!-- /ko -->
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
				</div>
			</div>

			<div class="box box-danger box-borderless" data-bind="visible: current_mode() === 'min_length', with: min_length">
				<div class="box-header">
					<h3 class="box-title">Выбор нуля глубины</h3>
				</div>

				<div class="box-body">
					<ul class="list-unstyled">
						<li>Ноль глубины: <span data-bind="text: value"></span></li>
					</ul>
				</div>

				<div class="box-footer">
					<a class="btn btn-sm btn-danger" data-bind="click: save, css: { 'btn-disabled': !is_save_allowed() }">
						<span>Сохранить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
				</div>
			</div>

			<div class="box box-danger box-solid" data-bind="visible: current_mode() === 'timeline_event', with: timeline_events">
				<div class="box-header">
					<h3 class="box-title">События на таймлайне</h3>
				</div>

				<div class="box-body">
					<!-- ko if: events().length === 0 -->
					<p class="placeholder">У вас пока нет событий</p>
					<!-- /ko -->

					<!-- ko ifnot: events().length === 0 -->
					<ul class="list-unstyled timeline-events" data-bind="foreach: events">
						<li>
							<!-- ko ifnot: $parent.is_editing() && $parent.current_event().id == $data.id -->
							<b data-bind="
                                text: short_text,
                                click: $parent.showEventOnPlot
                            "></b>
							<span class="btn-hoverable pull-right">
								<a data-bind="click: $parent.editEvent">
									<i class="fa fa-pencil"></i>
								</a>
								<a data-bind="click: $parent.removeEvent">
									<i class="fa fa-times"></i>
								</a>
							</span>
							<div style="overflow-wrap: break-word;" data-bind="click: $parent.showEventOnPlot">
								<span data-bind="text: description"></span>
								<span class="formatDate" data-bind="text: jmask_date"></span>
							</div>

							<!-- /ko -->

							<!-- ko if: $parent.is_editing() && $parent.current_event().id == $data.id -->
							<!-- ko with: $parent.current_event -->
							<div class="editbox timeline-event-template" data-bind="template: { name: 'timeline-event-template' }">
							</div>
							<!-- /ko -->
							<!-- /ko -->
						</li>
					</ul>
					<!-- /ko -->

					<!-- ko ifnot: is_editing -->
					<a class="btn btn-sm btn-danger" data-bind="click: createEvent">
						<span>Добавить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
					<!-- /ko -->

					<!-- ko if: is_editing() && !current_event().id -->
                    <!-- ko with: current_event -->
					<div class="editbox timeline-event-template" data-bind="template: 'timeline-event-template'"></div>
					<!-- /ko -->
                    <!-- /ko -->
				</div>
			</div>

			<div class="box box-danger box-solid" data-bind="visible: current_mode() === 'length_annotation', with: length_annotations">
				<div class="box-header">
					<h3 class="box-title">Конструкционные элементы</h3>
				</div>

				<div class="box-body">
					<!-- ko if: annotations().length === 0 -->
					<p class="placeholder">У вас пока не отмечены конструкционные элементы</p>
					<!-- /ko -->

					<!-- ko ifnot: annotations().length === 0 -->
					<ul class="list-unstyled timeline-events" data-bind="foreach: annotations">
						<li>
							<!-- ko ifnot: $parent.is_editing() && $parent.current_annotation().id == $data.id -->
							<b data-bind="
                                text: name
                            "></b> (<i data-bind="text: texture_name"></i>)
							<span class="btn-hoverable pull-right"> <a data-bind="click: $parent.editAnnotation">
                                <i class="fa fa-pencil"></i>
                            </a>
                            <a  data-bind="click: $parent.removeAnnotation">
                                <i class="fa fa-times"></i>
                            </a></span>
							<div>
								<span data-bind="text: y1"></span>м - <span data-bind="text: y2"></span>м
							</div>

							<!-- /ko -->

							<!-- ko if: $parent.is_editing() && $parent.current_annotation().id == $data.id -->
							<div>
								<!-- ko with: $parent.current_annotation -->
								<div class="box box-default box-borderless timeline-event-template" data-bind="template: { name: 'length-annotation-template' }">
								</div>
								<!-- /ko -->
							</div>
							<!-- /ko -->
						</li>
					</ul>
					<!-- /ko -->

					<!-- ko ifnot: is_editing -->
					<a class="btn btn-sm btn-danger" data-bind="click: createAnnotation">
						<span>Добавить</span>
					</a>
					<a class="btn btn-sm btn-default" data-bind="click: cancel">
						<span>Отмена</span>
					</a>
					<!-- /ko -->

					<!-- ko if: is_editing() && !current_annotation().id -->
                    <!-- ko with: current_annotation -->
					<div class="box box-default box-borderless timeline-event-template" data-bind="template: 'length-annotation-template'"></div>
                    <!-- /ko -->
					<!-- /ko -->
				</div>
			</div>

            <div class="box box-danger box-solid" data-bind="visible: current_mode() === 'sensors', with: sensors">
                <div class="box-header">
                    <h3 class="box-title">Датчики</h3>
                </div>

                <!-- ko if: $parent.current_well -->
                <div class="box-body">
                    <!-- ko if: $parent.current_well().time_sensors().length === 0 -->
                    <p class="placeholder">У этой скважины отсутствуют точечные датчики</p>
                    <!-- /ko -->

                    <!-- ko ifnot: $parent.current_well().time_sensors().length === 0 -->
                    <ul class="list-unstyled timeline-events" data-bind="foreach: $parent.current_well().time_sensors">
                        <li>
                            <input type="checkbox" data-bind="checked: is_active" />
                            <span data-bind="
                                text: name
                            "></span>
                        </li>
                    </ul>
                    <!-- /ko -->

                    <a class="btn btn-sm btn-default" data-bind="click: close">
                        <span>Закрыть</span>
                    </a>
                </div>
                <!-- /ko -->
            </div>
		</div>
	</div>
</section>

<script type="text/html" id="timeline-event-template">
	<div>
		<ul class="list-unstyled">
			<li class="form-group">
				<label>Дата:</label>
				<input class="form-control" class="axis-input-block-bottom-right" data-bind="
                textInput: jmask_date,
                jmask: {
                    mask: '00/00/00 00:00',
                    options: {
                        placeholder: '__/__/__ __:__'
                    }
                }
                ">
			</li>
			<li class="form-group">
				<label>Краткое обозначение:</label>
				<input class="form-control" data-bind="textInput: short_text" maxlength="5">
			</li>
			<li class="form-group">
				<label>Описание:</label>
				<textarea class="form-control" data-bind="textInput: description" style="
                    width: 100%;
                    min-height: 5em;
                    resize: vertical;
                "></textarea>
			</li>
		</ul>
	</div>

	<div>
		<a class="btn btn-sm btn-danger" data-bind="click: m_site.plots.timeline_events.saveEvent">
			<span>Сохранить</span>
		</a>
		<a class="btn btn-sm btn-default" data-bind="click: m_site.plots.timeline_events.cancelEditingEvent">
			<span>Отмена</span>
		</a>
	</div>
</script>

<script type="text/html" id="length-annotation-template">
    <div>
		<ul class="list-unstyled">
			<li class="form-group">
				<label>Название:</label>
				<input class="form-control" data-bind="textInput: name">
			</li>
            <li class="form-group">
				<label>Текстура:</label>
                <div class="length-annotation-select">
                    <select class="form-control" data-bind="
                        options: m_site.state.textures,
                        optionsCaption: 'Выберите текстуру...',
                        optionsText: 'name',
                        optionsValue: 'id',
                        value: texture_id
                    "></select>
                    <!-- ko if: texture_id -->
                    <div data-bind="style: {
                        'background-image': texture_img
                    }">
                    </div>
                    <!-- /ko -->
                </div>
			</li>
            <li class="form-group">
				<label>Начало отметки (м):</label>
				<input class="form-control" data-bind="textInput: y1">
			</li>
            <li class="form-group">
				<label>Конец отметки (м):</label>
				<input class="form-control" data-bind="textInput: y2">
			</li>
		</ul>
	</div>

	<div>
		<a class="btn btn-sm btn-danger" data-bind="click: m_site.plots.length_annotations.saveAnnotation">
			<span>Сохранить</span>
		</a>
		<a class="btn btn-sm btn-default" data-bind="click: m_site.plots.length_annotations.cancelEditingAnnotation">
			<span>Отмена</span>
		</a>
	</div>
</script>
